{% load static %}
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manajemen Pesanan - NetFast Admin</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="{% static 'css/admin.css' %}" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <!-- Mobile Header -->
        <nav class="navbar navbar-expand-md navbar-light bg-light d-md-none">
            <div class="container-fluid">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mobileSidebar" aria-controls="mobileSidebar" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <span class="navbar-brand mb-0 h1">
                    <i class="bi bi-wifi fs-4 me-2 text-primary"></i>
                    <span class="fs-4 fw-bold text-primary">NetFast</span>
                </span>
            </div>
        </nav>

        <!-- Mobile Sidebar (Collapsible) -->
        <div class="collapse d-md-none" id="mobileSidebar">
            <nav class="bg-light sidebar">
                <div class="position-sticky pt-3">
                    <div class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-decoration-none">
                        <i class="bi bi-wifi fs-4 me-2 text-primary"></i>
                        <span class="fs-4 fw-bold text-primary">NetFast</span>
                    </div>
                    <hr>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/dashboard/">
                                <i class="bi bi-house-door me-2"></i>
                                Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="/admin/manajemen-pesanan/">
                                <i class="bi bi-clipboard-check me-2"></i>
                                Pesanan
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/manajemen-teknisi/">
                                <i class="bi bi-wrench me-2"></i>
                                Teknisi
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/manajemen-pelanggan/">
                                <i class="bi bi-people me-2"></i>
                                Pelanggan
                            </a>
                        </li>
                    </ul>
                    <hr>
                    <div class="dropdown">
                        <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle" id="dropdownUser1" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person-circle me-2 fs-4"></i>
                            <strong>Admin</strong>
                        </a>
                        <ul class="dropdown-menu text-small shadow" aria-labelledby="dropdownUser1">
                            <li><a class="dropdown-item" href="#" onclick="logout()">Sign out</a></li>
                        </ul>
                    </div>
                </div>
            </nav>
        </div>

        <div class="row">
            <!-- Desktop Sidebar -->
            <nav id="sidebar" class="col-md-3 col-lg-2 d-none d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <div class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-decoration-none">
                        <i class="bi bi-wifi fs-4 me-2 text-primary"></i>
                        <span class="fs-4 fw-bold text-primary">NetFast</span>
                    </div>
                    <hr>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/dashboard/">
                                <i class="bi bi-house-door me-2"></i>
                                Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="/admin/manajemen-pesanan/">
                                <i class="bi bi-clipboard-check me-2"></i>
                                Pesanan
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/manajemen-teknisi/">
                                <i class="bi bi-wrench me-2"></i>
                                Teknisi
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/manajemen-pelanggan/">
                                <i class="bi bi-people me-2"></i>
                                Pelanggan
                            </a>
                        </li>
                    </ul>
                    <hr>
                    <div class="dropdown">
                        <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle" id="dropdownUser1" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person-circle me-2 fs-4"></i>
                            <strong>Admin</strong>
                        </a>
                        <ul class="dropdown-menu text-small shadow" aria-labelledby="dropdownUser1">
                            <li><a class="dropdown-item" href="#" onclick="logout()">Sign out</a></li>
                        </ul>
                    </div>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Manajemen Pesanan</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <button type="button" class="btn btn-primary" onclick="refreshData()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                        </button>
                    </div>
                </div>

                <!-- Alert Messages -->
                <div id="alertContainer"></div>

                <!-- Pending Orders Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-clock-history me-2"></i>Pesanan Menunggu Penugasan
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="pendingOrdersTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>ID Pesanan</th>
                                        <th>Pelanggan</th>
                                        <th>Alamat</th>
                                        <th>Jenis Jasa</th>
                                        <th>Status Pembayaran</th>
                                        <th>Tanggal Pesan</th>
                                        <th>Jadwal</th>
                                        <th>Pilih Teknisi</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="pendingOrdersTableBody">
                                    <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Active Orders Section with Payment Info -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-gear me-2"></i>Pesanan Dalam Pengerjaan & Pembayaran
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="activeOrdersTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>ID Pesanan</th>
                                        <th>Pelanggan</th>
                                        <th>Teknisi</th>
                                        <th>Jenis Jasa</th>
                                        <th>Metode Pembayaran</th>
                                        <th>Jumlah Bayar</th>
                                        <th>Status Pembayaran</th>
                                        <th>Tanggal Pembayaran</th>
                                        <th>Status Pesanan</th>
                                        <th>Tanggal Pesan</th>
                                        <th>Jadwal</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="activeOrdersTableBody">
                                    <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Completed Orders Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-check-circle me-2"></i>Riwayat Pesanan Selesai
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="completedOrdersTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>ID Pesanan</th>
                                        <th>Pelanggan</th>
                                        <th>Teknisi</th>
                                        <th>Jenis Jasa</th>
                                        <th>Metode Pembayaran</th>
                                        <th>Jumlah Bayar</th>
                                        <th>Status Pembayaran</th>
                                        <th>Tanggal Pembayaran</th>
                                        <th>Status Pesanan</th>
                                        <th>Tanggal Pesan</th>
                                    </tr>
                                </thead>
                                <tbody id="completedOrdersTableBody">
                                    <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_BASE_URL = '/api/admin';

        // Load data on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadPendingOrders();
            loadActiveOrders();
            loadPaidOrders();
            loadCompletedOrders();
        });

        // Load pending orders
        async function loadPendingOrders() {
            try {
                const response = await fetch(`${API_BASE_URL}/pesanan-menunggu/`);
                if (response.ok) {
                    const orders = await response.json();
                    displayPendingOrders(orders);
                } else {
                    showAlert('Gagal memuat pesanan menunggu', 'danger');
                }
            } catch (error) {
                console.error('Error loading pending orders:', error);
                showAlert('Terjadi kesalahan saat memuat data', 'danger');
            }
        }

        // Load active orders
        async function loadActiveOrders() {
            try {
                const response = await fetch(`${API_BASE_URL}/pesanan-aktif/`);
                if (response.ok) {
                    const orders = await response.json();
                    displayActiveOrders(orders);
                } else {
                    showAlert('Gagal memuat pesanan aktif', 'danger');
                }
            } catch (error) {
                console.error('Error loading active orders:', error);
                showAlert('Terjadi kesalahan saat memuat data', 'danger');
            }
        }

        // Load paid orders
        async function loadPaidOrders() {
            try {
                const response = await fetch(`${API_BASE_URL}/pesanan-aktif/`);
                if (response.ok) {
                    const orders = await response.json();
                    // Filter only orders with payment information
                    const paidOrders = orders.filter(order => order.payment_id || order.payment_status);
                    displayPaidOrders(paidOrders);
                } else {
                    showAlert('Gagal memuat pesanan yang membayar', 'danger');
                }
            } catch (error) {
                console.error('Error loading paid orders:', error);
                showAlert('Terjadi kesalahan saat memuat data pesanan pembayaran', 'danger');
            }
        }

        // Load completed orders
        async function loadCompletedOrders() {
            try {
                const response = await fetch(`${API_BASE_URL}/pesanan-selesai/`);
                if (response.ok) {
                    const orders = await response.json();
                    displayCompletedOrders(orders);
                } else {
                    showAlert('Gagal memuat pesanan selesai', 'danger');
                }
            } catch (error) {
                console.error('Error loading completed orders:', error);
                showAlert('Terjadi kesalahan saat memuat data pesanan selesai', 'danger');
            }
        }

        // Load technicians list
        async function loadTechnicians() {
            try {
                const response = await fetch(`${API_BASE_URL}/teknisi/`);
                if (response.ok) {
                    return await response.json();
                }
                return [];
            } catch (error) {
                console.error('Error loading technicians:', error);
                return [];
            }
        }

        // Display pending orders
        async function displayPendingOrders(orders) {
            const tbody = document.getElementById('pendingOrdersTableBody');
            const technicians = await loadTechnicians();

            tbody.innerHTML = '';

            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center">Tidak ada pesanan menunggu penugasan</td></tr>';
                return;
            }

            orders.forEach(order => {
                const row = document.createElement('tr');

                // Create technician select dropdown
                let teknisiOptions = '<option value="">Pilih Teknisi</option>';
                technicians.forEach(teknisi => {
                    teknisiOptions += `<option value="${teknisi.id_teknisi}">${teknisi.nama_teknisi}</option>`;
                });

                const customerName = order.id_pelanggan?.nama_lengkap || 'N/A';
                const address = order.id_pelanggan?.alamat_pemasangan || 'N/A';
                const serviceType = order.nama_jasa || order.id_jenis_jasa?.nama_jasa || 'N/A';
                const orderDate = new Date(order.tanggal_pemesanan).toLocaleDateString('id-ID');
                const scheduleDate = order.tanggal_jadwal ? new Date(order.tanggal_jadwal).toLocaleDateString('id-ID') : 'Belum dijadwalkan';

                // Payment status badge
                let paymentStatusClass = 'bg-secondary';
                let paymentStatusText = order.payment_status || 'Belum Bayar';

                switch(paymentStatusText.toLowerCase()) {
                    case 'lunas':
                    case 'bayar':
                        paymentStatusClass = 'bg-success';
                        break;
                    case 'menunggu verifikasi':
                    case 'belum bayar':
                    case 'pending':
                        paymentStatusClass = 'bg-warning';
                        break;
                    case 'batal':
                        paymentStatusClass = 'bg-danger';
                        break;
                }

                row.innerHTML = `
                    <td>${order.id_pemesanan}</td>
                    <td>${customerName}</td>
                    <td>${address}</td>
                    <td>${serviceType}</td>
                    <td><span class="badge ${paymentStatusClass}">${paymentStatusText}</span></td>
                    <td>${orderDate}</td>
                    <td>${scheduleDate}</td>
                    <td>
                        <select class="form-select form-select-sm teknisi-select" data-order-id="${order.id_pemesanan}">
                            ${teknisiOptions}
                        </select>
                    </td>
                    <td>
                        <button class="btn btn-success btn-sm" onclick="assignTechnician(${order.id_pemesanan})">
                            <i class="bi bi-check-circle me-1"></i>Tugaskan
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Display active orders with payment info
        function displayActiveOrders(orders) {
            const tbody = document.getElementById('activeOrdersTableBody');
            tbody.innerHTML = '';

            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="text-center">Tidak ada pesanan dalam pengerjaan</td></tr>';
                return;
            }

            orders.forEach(order => {
                const row = document.createElement('tr');

                // Status badge class
                let statusClass = 'bg-secondary';
                let statusText = order.status_pemesanan;

                switch(order.status_pemesanan) {
                    case 'Ditugaskan':
                        statusClass = 'bg-info';
                        break;
                    case 'Dikerjakan':
                        statusClass = 'bg-warning';
                        break;
                    case 'Selesai':
                        statusClass = 'bg-success';
                        break;
                    case 'Batal':
                        statusClass = 'bg-danger';
                        break;
                }

                // Payment status badge
                let paymentStatusClass = 'bg-secondary';
                let paymentStatusText = order.payment_status || 'Belum Bayar';

                switch(paymentStatusText.toLowerCase()) {
                    case 'lunas':
                    case 'bayar':
                        paymentStatusClass = 'bg-success';
                        break;
                    case 'menunggu verifikasi':
                    case 'belum bayar':
                    case 'pending':
                        paymentStatusClass = 'bg-warning';
                        break;
                    case 'batal':
                        paymentStatusClass = 'bg-danger';
                        break;
                }

                const customerName = order.id_pelanggan?.nama_lengkap || 'N/A';
                const technicianName = order.id_teknisi?.nama_teknisi || 'Belum ditugaskan';
                const serviceType = order.nama_jasa || order.id_jenis_jasa?.nama_jasa || 'N/A';
                const paymentMethod = order.payment_method || '-';
                const paymentAmount = order.payment_amount ? new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(order.payment_amount) : '-';
                const paymentDate = order.payment_date ? new Date(order.payment_date).toLocaleDateString('id-ID') : '-';
                const orderDate = new Date(order.tanggal_pemesanan).toLocaleDateString('id-ID');
                const scheduleDate = order.tanggal_jadwal ? new Date(order.tanggal_jadwal).toLocaleDateString('id-ID') : 'Belum dijadwalkan';

                row.innerHTML = `
                    <td><strong>#${order.id_pemesanan}</strong></td>
                    <td>${customerName}</td>
                    <td>${technicianName}</td>
                    <td>${serviceType}</td>
                    <td>${paymentMethod}</td>
                    <td class="text-end">${paymentAmount}</td>
                    <td><span class="badge ${paymentStatusClass}">${paymentStatusText}</span></td>
                    <td>${paymentDate}</td>
                    <td><span class="badge ${statusClass}</span>${statusText}</span></td>
                    <td>${orderDate}</td>
                    <td>${scheduleDate}</td>
                    <td>
                        <button class="btn btn-info btn-sm" onclick="viewPaymentDetail(${order.id_pemesanan})" title="Lihat Detail Pembayaran">
                            <i class="bi bi-eye me-1"></i>Detail
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Display paid orders (alias untuk compatibility)
        function displayPaidOrders(orders) {
            displayActiveOrders(orders);
        }

        // Display completed orders
        function displayCompletedOrders(orders) {
            const tbody = document.getElementById('completedOrdersTableBody');
            tbody.innerHTML = '';

            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center">Tidak ada pesanan selesai</td></tr>';
                return;
            }

            orders.forEach(order => {
                const row = document.createElement('tr');

                // Status badge class
                let statusClass = 'bg-secondary';
                let statusText = order.status_pemesanan;

                switch(order.status_pemesanan) {
                    case 'Selesai':
                        statusClass = 'bg-success';
                        break;
                    case 'Batal':
                        statusClass = 'bg-danger';
                        break;
                }

                // Payment status badge
                let paymentStatusClass = 'bg-secondary';
                let paymentStatusText = order.payment_status || 'Belum Bayar';

                switch(paymentStatusText.toLowerCase()) {
                    case 'lunas':
                    case 'bayar':
                        paymentStatusClass = 'bg-success';
                        break;
                    case 'menunggu verifikasi':
                    case 'belum bayar':
                    case 'pending':
                        paymentStatusClass = 'bg-warning';
                        break;
                    case 'batal':
                        paymentStatusClass = 'bg-danger';
                        break;
                }

                const customerName = order.id_pelanggan?.nama_lengkap || 'N/A';
                const technicianName = order.id_teknisi?.nama_teknisi || 'Belum ditugaskan';
                const serviceType = order.nama_jasa || order.id_jenis_jasa?.nama_jasa || 'N/A';
                const paymentMethod = order.payment_method || '-';
                const paymentAmount = order.payment_amount ? new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(order.payment_amount) : '-';
                const paymentDate = order.payment_date ? new Date(order.payment_date).toLocaleDateString('id-ID') : '-';
                const orderDate = new Date(order.tanggal_pemesanan).toLocaleDateString('id-ID');

                row.innerHTML = `
                    <td><strong>#${order.id_pemesanan}</strong></td>
                    <td>${customerName}</td>
                    <td>${technicianName}</td>
                    <td>${serviceType}</td>
                    <td>${paymentMethod}</td>
                    <td class="text-end">${paymentAmount}</td>
                    <td><span class="badge ${paymentStatusClass}">${paymentStatusText}</span></td>
                    <td>${paymentDate}</td>
                    <td><span class="badge ${statusClass}">${statusText}</span></td>
                    <td>${orderDate}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Assign technician to order
        async function assignTechnician(orderId) {
            const selectElement = document.querySelector(`select[data-order-id="${orderId}"]`);
            const teknisiId = selectElement.value;

            if (!teknisiId) {
                showAlert('Silakan pilih teknisi terlebih dahulu', 'warning');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/tugaskan-teknisi/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({
                        id_pemesanan: orderId,
                        id_teknisi: teknisiId
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    showAlert('Teknisi berhasil ditugaskan', 'success');
                    // Reload data
                    loadPendingOrders();
                    loadActiveOrders();
                    loadCompletedOrders();
                } else {
                    const error = await response.json();
                    showAlert(`Gagal menugaskan teknisi: ${error.error || 'Unknown error'}`, 'danger');
                }
            } catch (error) {
                console.error('Error assigning technician:', error);
                showAlert('Terjadi kesalahan saat menugaskan teknisi', 'danger');
            }
        }

        // Refresh data
        function refreshData() {
            loadPendingOrders();
            loadActiveOrders();
            loadPaidOrders();
            showAlert('Data berhasil diperbarui', 'info');
        }

        // View payment detail
        function viewPaymentDetail(orderId) {
            alert(`Detail pembayaran untuk pesanan #${orderId}\n\nFitur detail pembayaran akan segera tersedia.`);
            // Implementasi modal untuk menampilkan detail pembayaran bisa ditambahkan di sini
        }

        // Get CSRF token
        function getCSRFToken() {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            return csrfToken ? csrfToken.value : '';
        }

        // Show alert
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            alertContainer.appendChild(alert);

            // Auto remove after 5 seconds
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Logout function
        function logout() {
            if (confirm('Apakah Anda yakin ingin keluar?')) {
                fetch('/auth/logout/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    }
                })
                .then(response => response.json())
                .then(data => {
                    window.location.href = '/';
                })
                .catch(error => {
                    console.error('Logout error:', error);
                    window.location.href = '/';
                });
            }
        }
    </script>
</body>
</html>
