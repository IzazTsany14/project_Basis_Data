{% load static %}
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Riwayat Uji Kecepatan - NetFast</title>

    <!-- Bootstrap -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

    <style>
        /* ==== GLOBAL ==== */
        body {
            background: #f6f7fb;
            font-family: 'Poppins', sans-serif;
            color: #333;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ==== SIDEBAR ==== */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 230px;
            background: linear-gradient(180deg, #667eea, #764ba2);
            color: #fff;
            display: flex;
            flex-direction: column;
            padding: 25px 15px;
            z-index: 1000;
            transition: all 0.3s ease;
            box-shadow: 5px 0 25px rgba(0,0,0,0.08);
        }
        .sidebar h4 {
            font-weight: 700;
            text-align: center;
            margin-bottom: 40px;
            letter-spacing: 1px;
        }
        .sidebar a {
            color: #fff;
            text-decoration: none;
            padding: 12px 18px;
            margin: 8px 0;
            display: flex;
            align-items: center;
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        .sidebar a i {
            margin-right: 10px;
            font-size: 18px;
        }
        .sidebar a:hover,
        .sidebar a.active {
            background: rgba(255,255,255,0.2);
        }

        /* ==== NAVBAR ==== */
        .topbar {
            background: #fff;
            margin-left: 230px;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }
        .topbar h5 {
            margin: 0;
            font-weight: 600;
            color: #444;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .user-info img {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            border: 2px solid #667eea;
        }

        /* ==== MAIN CONTENT ==== */
        .main-content {
            margin-left: 230px;
            padding: 30px;
            transition: all 0.3s ease;
        }

        /* ==== CARD ==== */
        .card {
            border: none;
            border-radius: 20px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 25px rgba(0,0,0,0.1);
        }

        /* ==== BUTTONS ==== */
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 12px;
            padding: 10px 20px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
        }
        .btn-outline-primary {
            border: 2px solid #667eea;
            color: #667eea;
            background: transparent;
            border-radius: 12px;
            padding: 8px 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-outline-primary:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        /* ==== RESPONSIVE ==== */
        @media (max-width: 992px) {
            .sidebar {
                width: 70px;
            }
            .topbar, .main-content {
                margin-left: 70px;
            }
            .sidebar a span {
                display: none;
            }
            .sidebar h4 {
                display: none;
            }
        }
    </style>
</head>

<body>
    <!-- SIDEBAR -->
    <div class="sidebar">
        <h4>NetFast</h4>
        <a href="{% url 'dashboard' %}"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a>
        <a href="{% url 'speed_test' %}"><i class="fas fa-bolt"></i> <span>Uji Kecepatan</span></a>
        <a href="{% url 'packages' %}"><i class="fas fa-box"></i> <span>Paket Aktif</span></a>
        <a href="{% url 'services_history' %}"><i class="fas fa-history"></i> <span>Riwayat Layanan</span></a>
        <a href="{% url 'speed_history' %}" class="active"><i class="fas fa-chart-line"></i> <span>Riwayat Uji</span></a>
        <a href="{% url 'edit_profile' %}"><i class="fas fa-user-cog"></i> <span>Profil</span></a>
        <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> <span>Keluar</span></a>
    </div>

    <!-- TOPBAR -->
    <div class="topbar">
        <h5>Riwayat Uji Kecepatan</h5>
        <div class="user-info">
            <span>{{ user.nama }}</span>
            <img src="{% static 'images/profile.jpg' %}" alt="User">
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="fw-bold mb-3">ðŸ“ˆ Riwayat Uji Kecepatan</h4>
                        <p class="text-muted">Pantau performa koneksi internet Anda dari waktu ke waktu</p>
                    </div>
                    <button class="btn btn-primary" onclick="window.location.href='{% url 'speed_test' %}'">
                        <i class="fas fa-play me-2"></i> Lakukan Uji Baru
                    </button>
                </div>
            </div>
        </div>

        <div id="alertMessage" class="alert d-none alert-dismissible fade show" role="alert">
            <span id="alertText"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div class="row">
            <div class="col-lg-9">
                <div class="card p-4 mb-4">
                    <h6 class="card-title mb-3"><i class="fas fa-chart-line me-2"></i>Grafik Performa</h6>
                    <canvas id="speedChart" height="120"></canvas>
                </div>
            </div>
            <div class="col-lg-3">
                <div class="card p-4 mb-4">
                    <h6 class="card-title mb-3"><i class="fas fa-info-circle me-2"></i>Statistik</h6>
                    <div id="speedSummary">
                        <div class="text-center">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Memuat...</span>
                            </div>
                            <p class="mt-2 small text-muted">Memuat data...</p>
                        </div>
                    </div>
                </div>
                <div class="card p-4">
                    <h6 class="card-title mb-3"><i class="fas fa-cogs me-2"></i>Aksi</h6>
                    <button id="btnRefresh" class="btn btn-primary btn-sm w-100 mb-2">
                        <i class="fas fa-sync-alt me-2"></i>Muat Ulang
                    </button>
                    <a href="{% url 'dashboard' %}" class="btn btn-outline-primary btn-sm w-100">
                        <i class="fas fa-home me-2"></i>Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.3.0/chart.umd.min.js"></script>
    <!-- Auth JS -->
    <script src="{% static 'js/auth.js' %}"></script>

    <script>
        const ctx = document.getElementById('speedChart').getContext('2d');
        let speedChart = null;

        // Show alert function
        function showAlert(message, type = 'info') {
            const alertDiv = document.getElementById('alertMessage');
            const alertText = document.getElementById('alertText');
            alertText.textContent = message;
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.classList.remove('d-none');
            setTimeout(() => {
                alertDiv.classList.add('d-none');
            }, 5000);
        }

        async function fetchSpeedHistory() {
            try {
                const resp = await fetch('/api/speed-test/');
                if (!resp.ok) {
                    if (resp.status === 401) {
                        showAlert('Sesi Anda telah berakhir. Silakan login kembali.', 'warning');
                        setTimeout(() => window.location.href = '/', 2000);
                        return [];
                    }
                    throw new Error('Gagal memuat riwayat');
                }
                const data = await resp.json();
                // Expect array of tests
                const tests = Array.isArray(data) ? data.reverse() : (data.tests || []).reverse();
                return tests;
            } catch (e) {
                console.error(e);
                showAlert('Gagal memuat data riwayat uji kecepatan', 'danger');
                return [];
            }
        }

        function formatDateLabel(dt) {
            try {
                const d = new Date(dt);
                return d.toLocaleString('id-ID', {
                    day: '2-digit',
                    month: 'short',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return dt;
            }
        }

        function calculateStats(data) {
            if (!data || data.length === 0) return null;

            const downloads = data.map(t => Number(t.download_speed_mbps || t.download_speed || 0));
            const uploads = data.map(t => Number(t.upload_speed_mbps || t.upload_speed || 0));
            const pings = data.map(t => Number(t.ping_ms || t.ping || 0));

            return {
                avgDownload: downloads.reduce((a, b) => a + b, 0) / downloads.length,
                avgUpload: uploads.reduce((a, b) => a + b, 0) / uploads.length,
                avgPing: pings.reduce((a, b) => a + b, 0) / pings.length,
                maxDownload: Math.max(...downloads),
                minDownload: Math.min(...downloads),
                maxPing: Math.max(...pings),
                minPing: Math.min(...pings),
                totalTests: data.length
            };
        }

        async function renderChart() {
            const tests = await fetchSpeedHistory();
            if (!tests || tests.length === 0) {
                document.getElementById('speedSummary').innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Belum ada riwayat uji kecepatan</p>
                        <a href="{% url 'speed_test' %}" class="btn btn-primary btn-sm">
                            <i class="fas fa-play me-1"></i>Lakukan Uji Pertama
                        </a>
                    </div>
                `;
                if (speedChart) {
                    speedChart.destroy();
                    speedChart = null;
                }
                return;
            }

            const labels = tests.map(t => formatDateLabel(t.waktu_testing || t.tanggal_testing || t.waktu_testing));
            const downloadData = tests.map(t => Number(t.download_speed_mbps || t.download_speed || 0));
            const uploadData = tests.map(t => Number(t.upload_speed_mbps || t.upload_speed || 0));
            const pingData = tests.map(t => Number(t.ping_ms || t.ping || 0));

            // Calculate statistics
            const stats = calculateStats(tests);
            const latest = tests[tests.length - 1];

            // Update summary with enhanced stats
            document.getElementById('speedSummary').innerHTML = `
                <div class="stats-grid">
                    <div class="stat-item">
                        <small class="text-muted">Total Tes</small>
                        <div class="fw-bold text-primary">${stats.totalTests}</div>
                    </div>
                    <div class="stat-item">
                        <small class="text-muted">Rata-rata Download</small>
                        <div class="fw-bold">${stats.avgDownload.toFixed(1)} Mbps</div>
                    </div>
                    <div class="stat-item">
                        <small class="text-muted">Rata-rata Upload</small>
                        <div class="fw-bold">${stats.avgUpload.toFixed(1)} Mbps</div>
                    </div>
                    <div class="stat-item">
                        <small class="text-muted">Rata-rata Ping</small>
                        <div class="fw-bold">${stats.avgPing.toFixed(0)} ms</div>
                    </div>
                    <div class="stat-item">
                        <small class="text-muted">Download Maksimal</small>
                        <div class="fw-bold text-success">${stats.maxDownload.toFixed(1)} Mbps</div>
                    </div>
                    <div class="stat-item">
                        <small class="text-muted">Ping Terendah</small>
                        <div class="fw-bold text-success">${stats.minPing.toFixed(0)} ms</div>
                    </div>
                    <div class="stat-item full-width">
                        <small class="text-muted">Tes Terakhir</small>
                        <div class="fw-bold">${formatDateLabel(latest.waktu_testing || latest.tanggal_testing || latest.waktu_testing)}</div>
                    </div>
                </div>
            `;

            const datasets = [
                {
                    label: 'Download (Mbps)',
                    data: downloadData,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#667eea',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    yAxisID: 'y'
                },
                {
                    label: 'Upload (Mbps)',
                    data: uploadData,
                    borderColor: '#764ba2',
                    backgroundColor: 'rgba(118, 75, 162, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#764ba2',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    yAxisID: 'y'
                },
                {
                    label: 'Ping (ms)',
                    data: pingData,
                    borderColor: '#f093fb',
                    backgroundColor: 'rgba(240, 147, 251, 0.1)',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.4,
                    pointBackgroundColor: '#f093fb',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    yAxisID: 'y_ping'
                }
            ];

            if (speedChart) speedChart.destroy();

            speedChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.parsed.y;
                                    if (context.datasetIndex === 2) {
                                        label += ' ms';
                                    } else {
                                        label += ' Mbps';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Waktu Testing'
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Kecepatan (Mbps)'
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        },
                        y_ping: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Ping (ms)'
                            },
                            grid: {
                                drawOnChartArea: false,
                                color: 'rgba(0,0,0,0.05)'
                            }
                        }
                    }
                }
            });

            showAlert(`Berhasil memuat ${tests.length} data riwayat uji kecepatan`, 'success');
        }

        // Event listeners
        document.getElementById('btnRefresh').addEventListener('click', function() {
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Memuat...';
            this.disabled = true;
            renderChart().finally(() => {
                this.innerHTML = '<i class="fas fa-sync-alt me-2"></i>Muat Ulang';
                this.disabled = false;
            });
        });

        // Initial render
        renderChart();
    </script>

    <style>
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .stat-item {
            text-align: center;
            padding: 10px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 8px;
        }
        .stat-item.full-width {
            grid-column: 1 / -1;
        }
        .stat-item small {
            display: block;
            font-size: 0.75rem;
            margin-bottom: 5px;
        }
        .stat-item .fw-bold {
            font-size: 1.1rem;
        }
    </style>
</body>
</html>
