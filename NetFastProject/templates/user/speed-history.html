{% load static %}
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Riwayat Uji Kecepatan - NetFast</title>

    <!-- Bootstrap -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

    <style>
        /* ==== GLOBAL ==== */
        body {
            background: #f6f7fb;
            font-family: 'Poppins', sans-serif;
            color: #333;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ==== NAVBAR ==== */
        .navbar {
            background: linear-gradient(135deg, #667eea, #764ba2) !important;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .navbar-brand {
            font-weight: 700;
            color: #fff !important;
        }
        .navbar-nav .nav-link {
            color: rgba(255,255,255,0.9) !important;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .navbar-nav .nav-link:hover {
            color: #fff !important;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
        }
        .navbar-nav .nav-link.active {
            color: #fff !important;
            background: rgba(255,255,255,0.2);
            border-radius: 6px;
        }
        .navbar-toggler {
            border: none;
        }
        .navbar-toggler-icon {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%28255, 255, 255, 0.9%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='m4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
        }

        /* ==== MAIN CONTENT ==== */
        .main-content {
            padding: 30px 15px;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* ==== CARD ==== */
        .card {
            border: none;
            border-radius: 20px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 25px rgba(0,0,0,0.1);
        }

        /* ==== BUTTONS ==== */
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 12px;
            padding: 10px 20px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
        }
        .btn-outline-primary {
            border: 2px solid #667eea;
            color: #667eea;
            background: transparent;
            border-radius: 12px;
            padding: 8px 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-outline-primary:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        /* ==== RESPONSIVE ==== */
        @media (max-width: 992px) {
            .navbar-nav .nav-link span {
                display: none;
            }
            .navbar-brand span {
                display: none;
            }
        }
    </style>
</head>

<body>
    <!-- NAVIGATION BAR -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="{% url 'dashboard' %}">
                <i class="fas fa-wifi me-2"></i>NetFast
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'dashboard' %}">
                            <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'speed_test' %}">
                            <i class="fas fa-bolt me-1"></i>Uji Kecepatan
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'packages' %}">
                            <i class="fas fa-box me-1"></i>Paket Aktif
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'services_history' %}">
                            <i class="fas fa-history me-1"></i>Riwayat Layanan
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="{% url 'speed_history' %}">
                            <i class="fas fa-chart-line me-1"></i>Riwayat Uji
                        </a>
                    </li>
                </ul>

                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            {{ user.nama }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item" href="{% url 'edit_profile' %}">
                                <i class="fas fa-user-edit me-2"></i>Edit Profil
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()">
                                <i class="fas fa-sign-out-alt me-2"></i>Keluar
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- SIDEBAR -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebar" aria-labelledby="sidebarLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="sidebarLabel">Menu Navigasi</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'dashboard' %}">
                        <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'speed_test' %}">
                        <i class="fas fa-bolt me-2"></i>Uji Kecepatan
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'packages' %}">
                        <i class="fas fa-box me-2"></i>Paket Aktif
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'services_history' %}">
                        <i class="fas fa-history me-2"></i>Riwayat Layanan
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="{% url 'speed_history' %}">
                        <i class="fas fa-chart-line me-2"></i>Riwayat Uji
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'edit_profile' %}">
                        <i class="fas fa-user-edit me-2"></i>Edit Profil
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="logout()">
                        <i class="fas fa-sign-out-alt me-2"></i>Keluar
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="fw-bold mb-3">Riwayat Uji Kecepatan</h4>
                        <p class="text-muted">Pantau performa koneksi internet Anda dari waktu ke waktu</p>
                    </div>
                    <button class="btn btn-primary" onclick="window.location.href='{% url 'speed_test' %}'">
                        <i class="fas fa-play me-2"></i> Lakukan Uji Baru
                    </button>
                </div>
            </div>
        </div>

        <div id="alertMessage" class="alert d-none alert-dismissible fade show" role="alert">
            <span id="alertText"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div class="row">
            <div class="col-lg-9">
                <div class="card p-4 mb-4">
                    <h6 class="card-title mb-3"><i class="fas fa-chart-line me-2"></i>Grafik Performa</h6>
                    <div class="chart-container">
                        <canvas id="speedChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-3">
                <div class="card p-4 mb-4">
                    <h6 class="card-title mb-3"><i class="fas fa-info-circle me-2"></i>Statistik</h6>
                    <div id="speedSummary">
                        <div class="text-center">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Memuat...</span>
                            </div>
                            <p class="mt-2 small text-muted">Memuat data...</p>
                        </div>
                    </div>
                </div>
                <div class="card p-4">
                    <h6 class="card-title mb-3"><i class="fas fa-cogs me-2"></i>Aksi</h6>
                    <button id="btnRefresh" class="btn btn-primary btn-sm w-100 mb-2">
                        <i class="fas fa-sync-alt me-2"></i>Muat Ulang
                    </button>
                    <a href="{% url 'dashboard' %}" class="btn btn-outline-primary btn-sm w-100">
                        <i class="fas fa-home me-2"></i>Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.3.0/chart.umd.min.js"></script>
    <!-- Auth JS -->
    <script src="{% static 'js/auth.js' %}"></script>

    <script>
        // Logout function
        function logout() {
            if (confirm('Apakah Anda yakin ingin keluar?')) {
                fetch('/auth/logout/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                    }
                })
                .then(response => response.json())
                .then(data => {
                    window.location.href = '/';
                })
                .catch(error => {
                    console.error('Logout error:', error);
                    window.location.href = '/';
                });
            }
        }

        const ctx = document.getElementById('speedChart').getContext('2d');
        let speedChart = null;

        // Show alert function
        function showAlert(message, type = 'info') {
            const alertDiv = document.getElementById('alertMessage');
            const alertText = document.getElementById('alertText');
            alertText.textContent = message;
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.classList.remove('d-none');
            setTimeout(() => {
                alertDiv.classList.add('d-none');
            }, 5000);
        }

        async function fetchSpeedHistory() {
            try {
                const resp = await fetch('/api/speed-test/');
                if (!resp.ok) {
                    if (resp.status === 401) {
                        showAlert('Sesi Anda telah berakhir. Silakan login kembali.', 'warning');
                        setTimeout(() => window.location.href = '/', 2000);
                        return [];
                    }
                    throw new Error('Gagal memuat riwayat');
                }
                const data = await resp.json();
                // Expect array of tests
                const tests = Array.isArray(data) ? data.reverse() : (data.tests || []).reverse();
                return tests;
            } catch (e) {
                console.error(e);
                showAlert('Gagal memuat data riwayat uji kecepatan', 'danger');
                return [];
            }
        }

        function formatDateLabel(dt) {
            try {
                const d = new Date(dt);
                return d.toLocaleString('id-ID', {
                    day: '2-digit',
                    month: 'short',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return dt;
            }
        }

        function calculateStats(data) {
            if (!data || data.length === 0) return null;

            const downloads = data.map(t => Number(t.download_speed_mbps || t.download_speed || 0));
            const uploads = data.map(t => Number(t.upload_speed_mbps || t.upload_speed || 0));
            const pings = data.map(t => Number(t.ping_ms || t.ping || 0));

            return {
                avgDownload: downloads.reduce((a, b) => a + b, 0) / downloads.length,
                avgUpload: uploads.reduce((a, b) => a + b, 0) / uploads.length,
                avgPing: pings.reduce((a, b) => a + b, 0) / pings.length,
                maxDownload: Math.max(...downloads),
                minDownload: Math.min(...downloads),
                maxPing: Math.max(...pings),
                minPing: Math.min(...pings),
                totalTests: data.length
            };
        }

        async function renderChart() {
            const tests = await fetchSpeedHistory();
            if (!tests || tests.length === 0) {
                document.getElementById('speedSummary').innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Belum ada riwayat uji kecepatan</p>
                        <a href="{% url 'speed_test' %}" class="btn btn-primary btn-sm">
                            <i class="fas fa-play me-1"></i>Lakukan Uji Pertama
                        </a>
                    </div>
                `;
                if (speedChart) {
                    speedChart.destroy();
                    speedChart = null;
                }
                return;
            }

            const labels = tests.map(t => formatDateLabel(t.waktu_testing || t.tanggal_testing || t.waktu_testing));
            const downloadData = tests.map(t => Number(t.download_speed_mbps || t.download_speed || 0));
            const uploadData = tests.map(t => Number(t.upload_speed_mbps || t.upload_speed || 0));
            const pingData = tests.map(t => Number(t.ping_ms || t.ping || 0));

            // Calculate statistics
            const stats = calculateStats(tests);
            const latest = tests[tests.length - 1];

            // Update summary with enhanced stats
            document.getElementById('speedSummary').innerHTML = `
                <div class="stats-grid">
                    <div class="stat-item">
                        <small class="text-muted">Total Tes</small>
                        <div class="fw-bold text-primary">${stats.totalTests}</div>
                    </div>
                    <div class="stat-item">
                        <small class="text-muted">Rata-rata Download</small>
                        <div class="fw-bold">${stats.avgDownload.toFixed(1)} Mbps</div>
                    </div>
                    <div class="stat-item">
                        <small class="text-muted">Rata-rata Upload</small>
                        <div class="fw-bold">${stats.avgUpload.toFixed(1)} Mbps</div>
                    </div>
                    <div class="stat-item">
                        <small class="text-muted">Rata-rata Ping</small>
                        <div class="fw-bold">${stats.avgPing.toFixed(0)} ms</div>
                    </div>
                    <div class="stat-item">
                        <small class="text-muted">Download Maksimal</small>
                        <div class="fw-bold text-success">${stats.maxDownload.toFixed(1)} Mbps</div>
                    </div>
                    <div class="stat-item">
                        <small class="text-muted">Ping Terendah</small>
                        <div class="fw-bold text-success">${stats.minPing.toFixed(0)} ms</div>
                    </div>
                    <div class="stat-item full-width">
                        <small class="text-muted">Tes Terakhir</small>
                        <div class="fw-bold">${formatDateLabel(latest.waktu_testing || latest.tanggal_testing || latest.waktu_testing)}</div>
                    </div>
                </div>
            `;

            const datasets = [
                {
                    label: 'Download (Mbps)',
                    data: downloadData,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#667eea',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    yAxisID: 'y'
                },
                {
                    label: 'Upload (Mbps)',
                    data: uploadData,
                    borderColor: '#764ba2',
                    backgroundColor: 'rgba(118, 75, 162, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#764ba2',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    yAxisID: 'y'
                },
                {
                    label: 'Ping (ms)',
                    data: pingData,
                    borderColor: '#f093fb',
                    backgroundColor: 'rgba(240, 147, 251, 0.1)',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.4,
                    pointBackgroundColor: '#f093fb',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    yAxisID: 'y_ping'
                }
            ];

            if (speedChart) speedChart.destroy();

            speedChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.parsed.y;
                                    if (context.datasetIndex === 2) {
                                        label += ' ms';
                                    } else {
                                        label += ' Mbps';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Waktu Testing'
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Kecepatan (Mbps)'
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        },
                        y_ping: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Ping (ms)'
                            },
                            grid: {
                                drawOnChartArea: false,
                                color: 'rgba(0,0,0,0.05)'
                            }
                        }
                    }
                }
            });

            showAlert(`Berhasil memuat ${tests.length} data riwayat uji kecepatan`, 'success');
        }

        // Event listeners
        document.getElementById('btnRefresh').addEventListener('click', function() {
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Memuat...';
            this.disabled = true;
            renderChart().finally(() => {
                this.innerHTML = '<i class="fas fa-sync-alt me-2"></i>Muat Ulang';
                this.disabled = false;
            });
        });

        // Initial render
        renderChart();
    </script>

    <style>
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .stat-item {
            text-align: center;
            padding: 10px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 8px;
        }
        .stat-item.full-width {
            grid-column: 1 / -1;
        }
        .stat-item small {
            display: block;
            font-size: 0.75rem;
            margin-bottom: 5px;
        }
        .stat-item .fw-bold {
            font-size: 1.1rem;
        }

        /* Chart container for responsive sizing */
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }

        @media (max-width: 768px) {
            .chart-container {
                height: 300px;
            }
        }

        @media (max-width: 576px) {
            .chart-container {
                height: 250px;
            }
        }
    </style>
</body>
</html>
